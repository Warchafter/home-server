# =============================================================================
# Vaultwarden - Password Manager
# =============================================================================
# A lightweight, self-hosted Bitwarden-compatible password manager written in
# Rust. Works with all official Bitwarden apps and browser extensions.
#
# SETUP:
#   1. Run: bash scripts/setup.sh (generates self-signed TLS certificate)
#   2. Open https://SERVER_IP:8092 and create your account
#   3. IMPORTANT: After creating your account, set VAULTWARDEN_SIGNUPS_ALLOWED=false
#      in .env and run: docker compose up -d vaultwarden
#      This prevents anyone else from creating accounts on your server.
#
# HTTPS NOTE:
#   Vaultwarden serves its own HTTPS via ROCKET_TLS with a self-signed cert
#   (generated by setup.sh). This is required because the web vault uses the
#   browser's Web Crypto API, which only works in a secure context (HTTPS).
#   Your browser will show a one-time certificate warning — accept it.
#   For mobile apps, consider Tailscale MagicDNS HTTPS or a real domain.
#
# NOT PROXIED THROUGH CADDY — Vaultwarden handles TLS directly because
# mixing TLS and non-TLS port blocks in Caddy causes automation policy
# conflicts. Port 8092 goes straight to this container.
#
# Access at: https://SERVER_IP:8092
# =============================================================================

services:
  vaultwarden:
    image: vaultwarden/server:1.35.4
    container_name: vaultwarden
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
    ports:
      - "${SERVER_IP:?Set SERVER_IP in .env}:8092:80"
    environment:
      - TZ=${TZ:-UTC}
      # Allow new account registrations. Set to 'false' after creating your account!
      - SIGNUPS_ALLOWED=${VAULTWARDEN_SIGNUPS_ALLOWED:-false}
      # Self-signed TLS — cert generated by scripts/setup.sh
      - ROCKET_TLS={certs="/ssl/cert.pem",key="/ssl/key.pem"}
    volumes:
      # All vault data: encrypted passwords, attachments, config, SQLite database
      - vaultwarden_data:/data
      # TLS certificate (generated by setup.sh, gitignored)
      - ../vaultwarden/ssl:/ssl:ro
    networks:
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "curl -sfk https://localhost:80/alive || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128m

volumes:
  vaultwarden_data:
    name: vaultwarden_data

networks:
  proxy:
    external: true
